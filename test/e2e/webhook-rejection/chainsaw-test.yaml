---
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: webhook-rejection
spec:
  description: >
    Verify that the validating webhook rejects invalid Memcached CRs:
    memory limit too low, PDB with both/neither minAvailable and maxUnavailable,
    PDB minAvailable >= replicas, graceful shutdown with invalid timing,
    security features without secret refs, and autoscaling validation
    (REQ-005, REQ-006, REQ-007, REQ-008, REQ-009).
  timeouts:
    apply: 30s
    assert: 120s
    delete: 30s
  steps:
    - name: reject-insufficient-memory-limit
      try:
        - apply:
            file: 00-invalid-memory-limit.yaml
            expect:
              - check:
                  ($error != null): true
    - name: reject-pdb-mutual-exclusivity
      try:
        - apply:
            file: 01-invalid-pdb-both.yaml
            expect:
              - check:
                  ($error != null): true
    - name: reject-graceful-shutdown-invalid-period
      try:
        - apply:
            file: 02-invalid-graceful-shutdown.yaml
            expect:
              - check:
                  ($error != null): true
    - name: reject-sasl-without-secret-ref
      try:
        - apply:
            file: 03-invalid-sasl-no-secret.yaml
            expect:
              - check:
                  ($error != null): true
    - name: reject-tls-without-secret-ref
      try:
        - apply:
            file: 04-invalid-tls-no-secret.yaml
            expect:
              - check:
                  ($error != null): true
    - name: reject-pdb-neither-set
      try:
        - apply:
            file: 05-invalid-pdb-neither.yaml
            expect:
              - check:
                  ($error != null): true
    - name: reject-pdb-min-available-ge-replicas
      try:
        - apply:
            file: 06-invalid-pdb-min-ge-replicas.yaml
            expect:
              - check:
                  ($error != null): true
    - name: reject-autoscaling-replicas-conflict
      try:
        - apply:
            file: 07-invalid-autoscaling-replicas-conflict.yaml
            expect:
              - check:
                  ($error != null): true
    - name: reject-autoscaling-min-gt-max
      try:
        - apply:
            file: 08-invalid-autoscaling-min-gt-max.yaml
            expect:
              - check:
                  ($error != null): true
    - name: reject-autoscaling-cpu-no-request
      try:
        - apply:
            file: 09-invalid-autoscaling-cpu-no-request.yaml
            expect:
              - check:
                  ($error != null): true
