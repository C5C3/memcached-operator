{
  "feature_id": "MO-0044",
  "title": "L002: Create Kustomize namespace-scoped RBAC overlay",
  "slug": "l002-create-kustomize-namespace-scoped-rbac",
  "status": "proposed",
  "phase": null,
  "summary": "",
  "description": "**Size:** ðŸ”§ small\n**Category:** infrastructure\n**Priority:** medium\n**Source:** Proposed for 'Namespace-Scoped Operator Mode\n\nNew flag --watch'\n\nCreate new directory config/namespace-scoped/ with: (1) kustomization.yaml referencing ../rbac as base and applying patches, (2) role_patch.yaml with JSON or strategic merge patches that convert ClusterRole manager-role to Role and ClusterRoleBinding manager-rolebinding to RoleBinding (updating roleRef.kind accordingly). Leave leader-election-role (already a Role), metrics-auth-role, metrics-auth-rolebinding, metrics-reader, and service_account untouched. Verify with kustomize build that output produces correct Role/RoleBinding resources. Add documentation note that CRDs must be installed cluster-wide by an admin.\n\n**Rationale:** Namespace-scoped deployments require Role/RoleBinding instead of ClusterRole/ClusterRoleBinding for least-privilege RBAC. Providing a ready-made Kustomize overlay eliminates error-prone manual RBAC conversion and ensures correct configuration for namespace-scoped operator deployments.\n\n**Affected Areas:**\n- config/namespace-scoped/kustomization.yaml\n- config/namespace-scoped/role_patch.yaml",
  "stories": [],
  "requirements": [],
  "tasks": [],
  "test_specifications": [],
  "affected_files": [],
  "similar_patterns": [],
  "review_criteria": [],
  "implementation_notes": "",
  "status_history": {
    "proposed": {
      "github_account": "berendt",
      "timestamp": "2026-02-21T16:16:21.782652"
    }
  },
  "elaboration": "**Size:** ðŸ”¨ medium\n**Category:** infrastructure\n**Priority:** medium\n\n## Summary\n\nAdd a `--watch-namespaces` CLI flag to `cmd/main.go` that configures controller-runtime's `cache.Options.DefaultNamespaces` map, restricting the informer cache to only the specified namespaces. When the flag is empty (default), the operator retains its current cluster-scoped behavior. A new Kustomize overlay at `config/namespace-scoped/` provides Role/RoleBinding equivalents of the existing `manager-role` ClusterRole/ClusterRoleBinding, suitable for least-privilege namespace-scoped deployments.\n\n## Scope\n\n**Included:**\n- `--watch-namespaces` string flag in `cmd/main.go` (comma-separated, e.g. `--watch-namespaces=ns1,ns2`)\n- Parsing logic to build `map[string]cache.Config` from the flag value\n- Wiring the map into `ctrl.Options.Cache.DefaultNamespaces` at `cmd/main.go:80`\n- New Kustomize overlay `config/namespace-scoped/` with:\n  - `kustomization.yaml` referencing `../rbac` as base\n  - Patch converting `ClusterRole` `manager-role` â†’ `Role` and `ClusterRoleBinding` `manager-rolebinding` â†’ `RoleBinding`\n- Unit tests for namespace parsing (empty â†’ nil map, single namespace, multiple namespaces, whitespace trimming)\n- Documentation note: CRDs must be installed cluster-wide by an admin\n\n**Excluded (YAGNI):**\n- Dynamic namespace discovery at runtime (label-selector-based namespace watching) â€” not requested, significant complexity\n- Helm chart changes â€” separate concern\n- Webhook scoping/disabling â€” webhooks remain cluster-scoped in controller-runtime\n- Automatic per-namespace RBAC generation â€” user responsibility\n- Leader election RBAC changes â€” `leader-election-role` is already a namespace-scoped `Role` (`config/rbac/leader_election_role.yaml:3`)\n- Conversion of metrics RBAC â€” `metrics-auth-role` grants access to cluster-scoped `tokenreviews`/`subjectaccessreviews`; `metrics-reader` grants access to non-resource URL `/metrics` â€” both require ClusterRole\n- Changes to CRD installation â€” CRDs remain cluster-scoped by design\n\n## Visualization\n\n```mermaid\nflowchart TD\n    subgraph CLI[\"cmd/main.go\"]\n        FLAG[\"--watch-namespaces flag\"]\n        PARSE[\"Parse comma-separated string into map\"]\n        FLAG --> PARSE\n    end\n\n    subgraph MGR[\"ctrl.NewManager at line 80\"]\n        CACHE[\"Cache.DefaultNamespaces\"]\n        OPTS[\"ctrl.Options\"]\n        CACHE --> OPTS\n    end\n\n    PARSE -->|\"empty: nil map = cluster-wide\"| OPTS\n    PARSE -->|\"ns1,ns2: scoped map\"| CACHE\n\n    subgraph EXISTING[\"config/rbac/ - unchanged\"]\n        CR[\"ClusterRole manager-role\"]\n        CRB[\"ClusterRoleBinding manager-rolebinding\"]\n        LER[\"Role leader-election-role\"]\n        MAR[\"ClusterRole metrics-auth-role\"]\n        MR[\"ClusterRole metrics-reader\"]\n    end\n\n    subgraph OVERLAY[\"config/namespace-scoped/ - new\"]\n        KUST[\"kustomization.yaml\"]\n        PATCH[\"role_patch.yaml\"]\n    end\n\n    OVERLAY -->|\"patches\"| CR\n    OVERLAY -->|\"patches\"| CRB\n    CR -.->|\"becomes\"| R[\"Role manager-role\"]\n    CRB -.->|\"becomes\"| RB[\"RoleBinding manager-rolebinding\"]\n```\n\n```mermaid\nsequenceDiagram\n    participant U as User / CLI\n    participant M as main.go\n    participant C as ctrl.NewManager\n    participant K as Cache Informers\n\n    U->>M: --watch-namespaces=ns1,ns2\n    M->>M: Split comma-separated, trim whitespace\n    M->>M: Build map of string to cache.Config\n    M->>C: ctrl.Options with Cache.DefaultNamespaces\n    C->>K: Create informers scoped to ns1, ns2\n    Note over K: Only watches resources in ns1 and ns2\n```\n\n## Key Components\n\n- **`cmd/main.go:38-56`** (modify): Add `--watch-namespaces` string flag via `flag.StringVar`, parse into `map[string]cache.Config`, wire into `ctrl.Options.Cache` field at line 80. All managed resources (secrets, services, deployments, memcacheds, servicemonitors, networkpolicies, poddisruptionbudgets) are namespace-scoped, so `DefaultNamespaces` correctly restricts all informers.\n- **`config/namespace-scoped/kustomization.yaml`** (new): Overlay with `resources: [../rbac]` as base, referencing the patch file. Only targets `manager-role` and `manager-rolebinding`; leaves `leader-election-role`, `metrics-auth-role`, `metrics-auth-rolebinding`, `metrics-reader`, and `service_account` untouched.\n- **`config/namespace-scoped/role_patch.yaml`** (new): JSON patch or strategic merge patch converting `ClusterRole` â†’ `Role` (kind + apiVersion) and `ClusterRoleBinding` â†’ `RoleBinding` (kind + apiVersion + `roleRef.kind`). The `roleRef.name` (`manager-role`) and `subjects` stay the same.\n- **`config/rbac/role.yaml`** (existing, unchanged): `ClusterRole` `manager-role` â€” all rules reference namespace-scoped resources (secrets, services, deployments, memcacheds, servicemonitors, networkpolicies, poddisruptionbudgets, events).\n- **`config/rbac/role_binding.yaml`** (existing, unchanged): `ClusterRoleBinding` `manager-rolebinding` binding to ServiceAccount `controller-manager` in namespace `system`.\n- **`config/rbac/leader_election_role.yaml`** (existing, unchanged): Already a `Role` (not `ClusterRole`) â€” no action needed.\n- **`config/rbac/metrics_auth_role.yaml`** (existing, unchanged): Must remain `ClusterRole` â€” grants access to `tokenreviews` and `subjectaccessreviews`.\n- **`config/rbac/metrics_reader_role.yaml`** (existing, unchanged): Must remain `ClusterRole` â€” grants access to non-resource URL `/metrics`.\n- **Unit tests** (new): Validate namespace flag parsing â€” empty string â†’ nil map, `\"ns1\"` â†’ single-entry map, `\"ns1,ns2\"` â†’ two-entry map, `\" ns1 , ns2 \"` â†’ trimmed entries. Test that `ctrl.Options.Cache.DefaultNamespaces` is correctly populated."
}