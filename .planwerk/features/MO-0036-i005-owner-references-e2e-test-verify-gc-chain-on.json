{
  "feature_id": "MO-0036",
  "title": "I005: Owner references E2E test â€” verify GC chain on all child resources",
  "slug": "i005-owner-references-e2e-test-verify-gc-chain-on",
  "status": "proposed",
  "phase": null,
  "summary": "",
  "description": "**Size:** ðŸ“¦ medium\n**Category:** testing\n**Priority:** medium\n**Source:** Proposed for 'E2E tests with chainsaw are now working. Analysis'\n\nAdd 1 comprehensive Chainsaw E2E test that validates owner references on ALL operator-managed resources:\n\n**test/e2e/owner-references/**: Create a CR with monitoring + PDB + NetworkPolicy all enabled to maximize child resource creation. Explicitly assert `ownerReferences` on every child resource:\n- Deployment: ownerReference with correct owner UID, kind=Memcached, name matches CR\n- Service: same ownerReference assertions\n- PodDisruptionBudget: same ownerReference assertions\n- NetworkPolicy: same ownerReference assertions\n- ServiceMonitor: same ownerReference assertions\n\nThis validates the Kubernetes garbage collection chain â€” when the parent CR is deleted, all child resources must be cleaned up. The existing cr-deletion test verifies deletion happens, but this test explicitly verifies the mechanism (ownerReferences) is correctly set on creation.\n\n**Rationale:** Owner references are the foundation of Kubernetes garbage collection. If any child resource lacks correct ownerReferences, it becomes orphaned on CR deletion, leading to resource leaks. The existing cr-deletion test only checks the end result, not the mechanism. Explicit ownerReference validation catches bugs in new resource creation code paths before they cause orphaned resources in production.\n\n**Affected Areas:**\n- test/e2e/owner-references/chainsaw-test.yaml",
  "stories": [],
  "requirements": [],
  "tasks": [],
  "test_specifications": [],
  "affected_files": [],
  "similar_patterns": [],
  "review_criteria": [],
  "implementation_notes": "",
  "status_history": {
    "proposed": {
      "github_account": "berendt",
      "timestamp": "2026-02-20T23:27:34.055719"
    }
  },
  "elaboration": "\n\n**Size:** ðŸ—ï¸ large\n**Category:** infrastructure\n**Priority:** high\n\n## Summary\n\nAdd 13 new Chainsaw E2E tests to comprehensively cover all operator features currently lacking positive-path E2E validation. The existing 9 tests cover basic deployment, scaling, config changes, monitoring toggle, PDB, graceful shutdown, webhook defaulting/rejection, and garbage collection. Critical gaps exist for: SASL authentication, TLS encryption (including mTLS), NetworkPolicy lifecycle, service annotations, PDB with `maxUnavailable`, verbosity/extraArgs, custom exporter image, security contexts, anti-affinity presets, status degradation, scale-to-zero, and owner reference verification.\n\n## Scope\n\n**Included:**\n- SASL authentication positive path (secret creation, volume mounts, `-Y` arg)\n- TLS encryption positive path (cert-manager issued certs, volume/port, `-Z` and `ssl_*` args)\n- TLS with mTLS (`enableClientCert` adds `ssl_ca_cert` arg)\n- NetworkPolicy creation/deletion lifecycle with correct ports (resource creation verification only)\n- NetworkPolicy with `allowedSources` peer configuration\n- NetworkPolicy port adaptation (TLS port, metrics port)\n- PDB with `maxUnavailable` variant\n- Service custom annotations propagation and removal\n- Memcached verbosity flag (`-v`, `-vv`)\n- Memcached `extraArgs` propagation\n- Custom exporter image override\n- Pod and container security contexts\n- Anti-affinity preset \"hard\" (`requiredDuringSchedulingIgnoredDuringExecution`)\n- Status Degraded condition (invalid image triggers `Degraded=True`, `Available=False`)\n- Scale-to-zero boundary case (`replicas: 0`, `Available=False`, `readyReplicas: 0`)\n- Owner references explicit verification on all created resources\n\n**Excluded (YAGNI):**\n- Actual TLS handshake / SASL auth verification (requires memcached client in cluster)\n- NetworkPolicy enforcement testing (requires CNI plugin, flaky in kind)\n- Concurrent/chaos testing (out of scope for declarative E2E)\n- Soak/stability testing (separate concern)\n- TopologySpreadConstraints E2E (not meaningful in single-node kind cluster)\n- Large replica counts >10 (kind cluster resource constraints)\n\n## Visualization\n\n```mermaid\nflowchart TD\n    subgraph existing[\"Existing E2E Tests - 9\"]\n        T1[\"basic-deployment\"]\n        T2[\"scaling\"]\n        T3[\"configuration-changes\"]\n        T4[\"monitoring-toggle\"]\n        T5[\"pdb-creation\"]\n        T6[\"graceful-rolling-update\"]\n        T7[\"webhook-defaulting\"]\n        T8[\"webhook-rejection\"]\n        T9[\"cr-deletion\"]\n    end\n\n    subgraph new[\"New E2E Tests to Add - 13\"]\n        N1[\"sasl-authentication\"]\n        N2[\"tls-encryption\"]\n        N3[\"tls-mtls\"]\n        N4[\"network-policy\"]\n        N5[\"pdb-max-unavailable\"]\n        N6[\"service-annotations\"]\n        N7[\"verbosity-and-extra-args\"]\n        N8[\"custom-exporter-image\"]\n        N9[\"security-contexts\"]\n        N10[\"anti-affinity-hard\"]\n        N11[\"status-degraded\"]\n        N12[\"scale-to-zero\"]\n        N13[\"owner-references\"]\n    end\n\n    subgraph resources[\"Operator-Managed Resources\"]\n        D[\"Deployment\"]\n        S[\"Service\"]\n        P[\"PDB\"]\n        NP[\"NetworkPolicy\"]\n        SM[\"ServiceMonitor\"]\n    end\n\n    N1 --> D\n    N2 --> D\n    N2 --> S\n    N3 --> D\n    N4 --> NP\n    N5 --> P\n    N6 --> S\n    N7 --> D\n    N8 --> D\n    N9 --> D\n    N10 --> D\n    N11 --> D\n    N12 --> D\n    N13 --> D\n    N13 --> S\n    N13 --> P\n    N13 --> SM\n    N13 --> NP\n```\n\n```mermaid\nsequenceDiagram\n    participant CT as Chainsaw Test\n    participant K as Kind Cluster\n    participant OP as Operator\n    participant RES as K8s Resources\n\n    rect rgb(200, 230, 200)\n        note right of CT: SASL Test Flow\n        CT->>K: Create Secret with password-file\n        CT->>K: Apply Memcached CR with SASL enabled\n        K->>OP: Reconcile\n        OP->>RES: Create Deployment with SASL volume mount and -Y arg\n        CT->>RES: Assert volume, volumeMount, args contain -Y\n    end\n\n    rect rgb(200, 210, 240)\n        note right of CT: TLS Test Flow\n        CT->>K: Create cert-manager Certificate resource\n        CT->>K: Apply Memcached CR with TLS enabled\n        K->>OP: Reconcile\n        OP->>RES: Create Deployment with TLS volume, port 11212, -Z args\n        OP->>RES: Create Service with memcached-tls port\n        CT->>RES: Assert volumes, ports, args\n    end\n\n    rect rgb(240, 220, 200)\n        note right of CT: NetworkPolicy Test Flow\n        CT->>K: Apply Memcached CR with NetworkPolicy enabled\n        K->>OP: Reconcile\n        OP->>RES: Create NetworkPolicy with ingress rules\n        CT->>RES: Assert ports, podSelector, from peers\n        CT->>K: Patch to disable NetworkPolicy\n        K->>OP: Reconcile\n        OP->>RES: Delete NetworkPolicy\n        CT->>RES: Assert NetworkPolicy gone\n    end\n```\n\n## Key Components\n\n- **`test/e2e/sasl-authentication/`**: Creates a Secret with `password-file` key, applies CR with `security.sasl.enabled: true`, asserts Deployment has `sasl-credentials` volume, volumeMount at `/etc/memcached/sasl`, and container args include `-Y /etc/memcached/sasl/password-file`\n- **`test/e2e/tls-encryption/`**: Creates a cert-manager Certificate resource to generate real TLS certs in a Secret, applies CR with `security.tls.enabled: true`, asserts Deployment has `tls-certificates` volume, port 11212, and args include `-Z -o ssl_chain_cert=... -o ssl_key=...`. Service gains `memcached-tls` port\n- **`test/e2e/tls-mtls/`**: Same as TLS but with `enableClientCert: true`, asserts args also include `-o ssl_ca_cert=.../ca.crt` and TLS volume includes `ca.crt` key projection\n- **`test/e2e/network-policy/`**: Enables NetworkPolicy, asserts resource creation with correct podSelector and ingress ports (11211). Tests port adaptation when TLS (11212) and monitoring (9150) are also enabled. Tests `allowedSources` with a podSelector peer. Tests disable/deletion lifecycle\n- **`test/e2e/pdb-max-unavailable/`**: Creates PDB with `maxUnavailable: 1` instead of `minAvailable`, asserts correct PDB spec\n- **`test/e2e/service-annotations/`**: Applies CR with `service.annotations`, asserts Service metadata contains custom annotations. Patches to remove, asserts annotations cleared\n- **`test/e2e/verbosity-and-extra-args/`**: Tests `verbosity: 1` produces `-v` arg, `verbosity: 2` produces `-vv`, and `extraArgs: [\"-o\", \"modern\"]` appears in container args\n- **`test/e2e/custom-exporter-image/`**: Enables monitoring with custom `exporterImage`, asserts exporter container uses the specified image\n- **`test/e2e/security-contexts/`**: Applies CR with `podSecurityContext` (runAsNonRoot, fsGroup) and `containerSecurityContext` (readOnlyRootFilesystem, allowPrivilegeEscalation), asserts both contexts propagated to Deployment\n- **`test/e2e/anti-affinity-hard/`**: Applies CR with `antiAffinityPreset: hard`, asserts Deployment has `requiredDuringSchedulingIgnoredDuringExecution` pod anti-affinity\n- **`test/e2e/status-degraded/`**: Applies CR with non-existent image, asserts `Degraded=True` and `Available=False` status conditions\n- **`test/e2e/scale-to-zero/`**: Creates CR then patches `replicas: 0`, asserts Deployment has 0 replicas, `readyReplicas: 0`, and `Available=False`\n- **`test/e2e/owner-references/`**: Creates CR with monitoring + PDB + NetworkPolicy, explicitly asserts `ownerReferences` on every child resource (Deployment, Service, PDB, NetworkPolicy, ServiceMonitor) contain correct owner UID, kind, and name"
}