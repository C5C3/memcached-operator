{
  "feature_id": "MO-0052",
  "title": "N003: Optional component templates ‚Äî Webhooks, cert-manager, ServiceMonitor, NetworkPolicy",
  "slug": "n003-optional-component-templates-webhooks-cert",
  "status": "proposed",
  "phase": null,
  "summary": "",
  "description": "**Size:** üèóÔ∏è large\n**Category:** infrastructure\n**Priority:** high\n**Source:** Proposed for 'Helm Chart Packaging\n\nChart structure under charts/'\n\nImplement all conditionally-rendered Helm templates for optional components. Includes: templates/webhook/ with MutatingWebhookConfiguration, ValidatingWebhookConfiguration, and webhook Service (gated by webhook.enabled); templates/certmanager/ with Issuer and Certificate resources (gated by certmanager.enabled, which implies webhook.enabled); templates/servicemonitor.yaml for Prometheus monitoring (gated by serviceMonitor.enabled); and templates/networkpolicy.yaml for metrics ingress policy (gated by networkPolicy.enabled). Each template includes proper conditional blocks and cross-references (e.g., cert-manager Certificate references webhook Service).\n\n**Rationale:** These optional components represent the full feature set of the operator deployment. Webhooks and cert-manager are tightly coupled and must be templated together. ServiceMonitor and NetworkPolicy are independent but complete the chart's parity with the existing Kustomize configuration.\n\n**Affected Areas:**\n- charts/memcached-operator/templates/webhook/mutating-webhook.yaml\n- charts/memcached-operator/templates/webhook/validating-webhook.yaml\n- charts/memcached-operator/templates/webhook/service.yaml\n- charts/memcached-operator/templates/certmanager/issuer.yaml\n- charts/memcached-operator/templates/certmanager/certificate.yaml\n- charts/memcached-operator/templates/servicemonitor.yaml\n- charts/memcached-operator/templates/networkpolicy.yaml\n- config/webhook/\n- config/certmanager/\n- config/prometheus/",
  "stories": [],
  "requirements": [],
  "tasks": [],
  "test_specifications": [],
  "affected_files": [],
  "similar_patterns": [],
  "review_criteria": [],
  "implementation_notes": "",
  "status_history": {
    "proposed": {
      "github_account": "berendt",
      "timestamp": "2026-02-21T16:36:34.846997"
    }
  },
  "elaboration": "\n\n**Size:** üèóÔ∏è large\n**Category:** infrastructure\n**Priority:** high\n\n## Open Questions\n\nAll prior questions have been resolved by the user's selections:\n\n| # | Decision | Choice |\n|---|----------|--------|\n| 1 | CRD upgrade strategy | Both: `crds/` for install + optional template for managed upgrades |\n| 2 | Distribution format | OCI registry via GHCR |\n| 3 | Kustomize coexistence | Coexist ‚Äî Kustomize stays as-is, chart is additive |\n| 4 | Namespace-scope RBAC | Chart passes `watchNamespaces` as container arg only |\n\n**1. OCI push trigger and versioning?**\n\nThe user chose GHCR over GitHub Pages. This changes the release pipeline.\n\n1. **(Recommended) Push on Git tag matching `chart/v*` pattern** ‚Äî Decouples chart releases from operator image releases. Uses `helm push` to `oci://ghcr.io/<org>/charts/memcached-operator`. Chart version in `Chart.yaml` must match tag.\n2. **Push on every operator release tag `v*`** ‚Äî Ties chart version 1:1 to operator version. Simpler but prevents independent chart-only fixes (e.g. template bug with same operator version).\n\n**2. CRD template opt-in: separate value key or reuse `crds/` directory presence?**\n\nThe user chose \"both\" for CRD strategy. The optional template needs a toggle.\n\n1. **(Recommended) `crds.managedByHelm: false` in values.yaml** ‚Äî When `true`, CRD renders as a template (upgradeable via `helm upgrade`). Default `false` uses the `crds/` directory convention. Clear intent.\n2. **`crds.install: true` + `crds.keepOnUninstall: true`** ‚Äî Mirrors cert-manager's pattern. Two knobs instead of one.\n\n## Summary\n\nPackage the memcached-operator as a Helm chart under `charts/memcached-operator/`, translating all existing Kustomize manifests from `config/` into parameterized Helm templates. The chart exposes toggles for optional components (webhooks, cert-manager, ServiceMonitor, NetworkPolicy) and all deployment parameters as `values.yaml` entries. CRDs live in `crds/` for standard Helm install behavior, with an optional template path for managed upgrades. CI validates with `helm lint`, `chart-testing`, and `helm-unittest`. Releases publish to GHCR as an OCI artifact.\n\n## Scope\n\n**Included:**\n- `charts/memcached-operator/Chart.yaml` ‚Äî `appVersion` tracks operator version, `type: application`\n- `charts/memcached-operator/values.yaml` ‚Äî all tunables\n- Templates for: Deployment, ServiceAccount, ClusterRole/ClusterRoleBinding, LeaderElection Role/RoleBinding, Metrics roles, MutatingWebhookConfiguration, ValidatingWebhookConfiguration, Webhook Service, cert-manager Issuer + Certificate, ServiceMonitor, NetworkPolicy\n- CRD in `crds/` directory (Helm-native install) **plus** optional CRD template gated by `crds.managedByHelm`\n- Conditional rendering via `webhook.enabled`, `certmanager.enabled`, `serviceMonitor.enabled`, `networkPolicy.enabled`\n- `_helpers.tpl` with standard label/name/selector helpers matching existing `app.kubernetes.io/name` conventions\n- `helm-unittest` test suite under `charts/memcached-operator/tests/`\n- CI job in `.github/workflows/ci.yml`: `helm lint`, `ct lint`, `helm-unittest`\n- Release workflow publishing OCI artifact to `oci://ghcr.io/<org>/charts/memcached-operator` via `helm push`\n- Chart README with install/upgrade/CRD-upgrade instructions\n\n**Excluded (YAGNI):**\n- **Kustomize removal or migration** ‚Äî existing `make deploy` workflow and E2E tests remain untouched\n- **Namespace-scoped RBAC generation per watched namespace** ‚Äî user manages externally; chart only passes `--watch-namespaces` arg\n- **Helm hooks for CRD lifecycle** ‚Äî `crds/` + optional template covers both strategies without hook complexity\n- **GitHub Pages distribution** ‚Äî user chose OCI/GHCR; can add Pages later if needed\n- **Helm chart for the Memcached workload itself** ‚Äî chart manages only the operator\n- **`kube-linter` or `polaris` integration** ‚Äî separate concern\n\n## Visualization\n\n```mermaid\nflowchart TD\n    subgraph Chart[\"charts/memcached-operator/\"]\n        CY[\"Chart.yaml\"]\n        VY[\"values.yaml\"]\n        subgraph crds[\"crds/\"]\n            CRD[\"memcacheds CRD<br>#40;install-only#41;\"]\n        end\n        subgraph tpl[\"templates/\"]\n            HLP[\"_helpers.tpl\"]\n            DEP[\"deployment.yaml\"]\n            SA[\"serviceaccount.yaml\"]\n            subgraph rbac[\"rbac/\"]\n                CR[\"clusterrole + bindings\"]\n                LE[\"leader-election role\"]\n                MR[\"metrics roles\"]\n            end\n            subgraph wh[\"webhook/\"]\n                MWH[\"mutating + validating\"]\n                WS[\"webhook service\"]\n            end\n            CMT[\"cert-manager issuer + cert\"]\n            SM[\"servicemonitor.yaml\"]\n            NP[\"networkpolicy.yaml\"]\n            CRDT[\"crd-template.yaml<br>#40;opt-in#41;\"]\n        end\n        subgraph tests[\"tests/\"]\n            UT[\"helm-unittest suites\"]\n        end\n    end\n\n    VY -->|\"parameterizes\"| tpl\n    MWH -.->|\"webhook.enabled\"| WS\n    MWH -.->|\"certmanager.enabled\"| CMT\n    CRDT -.->|\"crds.managedByHelm\"| CRDT\n```\n\n```mermaid\nflowchart LR\n    subgraph CI[\"GitHub Actions - PR\"]\n        LINT[\"helm lint + ct lint\"]\n        UNIT[\"helm-unittest\"]\n    end\n    subgraph Release[\"GitHub Actions - Tag\"]\n        LOGIN[\"ghcr.io login\"]\n        PKG[\"helm package\"]\n        PUSH[\"helm push OCI\"]\n    end\n    subgraph Registry[\"GHCR\"]\n        OCI[\"oci://ghcr.io/org/charts/memcached-operator\"]\n    end\n\n    SRC[\"charts/memcached-operator/\"] -->|\"PR\"| LINT\n    SRC -->|\"PR\"| UNIT\n    SRC -->|\"tag chart/v*\"| LOGIN\n    LOGIN --> PKG\n    PKG --> PUSH\n    PUSH -->|\"publish\"| OCI\n    OCI -->|\"helm install\"| USER[\"User\"]\n```\n\n```mermaid\nflowchart LR\n    subgraph Install[\"helm install\"]\n        A[\"crds/ dir\"] -->|\"auto-apply\"| K1[\"CRD created\"]\n        B[\"templates/\"] -->|\"render\"| K2[\"Resources created\"]\n    end\n    subgraph Upgrade[\"helm upgrade\"]\n        C{\"crds.managedByHelm?\"}\n        C -->|\"true\"| D[\"CRD template rendered + applied\"]\n        C -->|\"false\"| E[\"kubectl apply -f crds/ #40;manual#41;\"]\n        F[\"templates/\"] -->|\"render\"| K3[\"Resources updated\"]\n    end\n```\n\n## Key Components\n\n- **`Chart.yaml`** ‚Äî Chart metadata; `appVersion` tracks operator version; `type: application`\n- **`values.yaml`** ‚Äî `image.repository`/`tag`, `replicaCount`, `resources`, `webhook.enabled`, `certmanager.enabled`, `serviceMonitor.enabled`, `networkPolicy.enabled`, `watchNamespaces`, `leaderElection.enabled`, `rbac.create`, `crds.managedByHelm`\n- **`templates/_helpers.tpl`** ‚Äî Standard label/name/selector helpers matching existing `app.kubernetes.io/name: memcached-operator` convention from `config/`\n- **`templates/deployment.yaml`** ‚Äî Translates `config/manager/manager.yaml`; parameterized image, replicas, resources, security context, args (including `--watch-namespaces`)\n- **`templates/rbac/`** ‚Äî ClusterRole, ClusterRoleBinding, ServiceAccount, leader-election Role/RoleBinding, metrics auth roles ‚Äî gated by `rbac.create`\n- **`templates/webhook/`** ‚Äî MutatingWebhookConfiguration + ValidatingWebhookConfiguration + Service ‚Äî gated by `webhook.enabled`\n- **`templates/certmanager/`** ‚Äî Issuer + Certificate ‚Äî gated by `certmanager.enabled` (implies `webhook.enabled`)\n- **`templates/servicemonitor.yaml`** ‚Äî Prometheus ServiceMonitor ‚Äî gated by `serviceMonitor.enabled`\n- **`templates/networkpolicy.yaml`** ‚Äî Metrics ingress NetworkPolicy ‚Äî gated by `networkPolicy.enabled`\n- **`crds/`** ‚Äî `memcached.c5c3.io_memcacheds.yaml` copied from `config/crd/bases/`; Helm installs on first install only\n- **`templates/crd-template.yaml`** ‚Äî Same CRD rendered as template when `crds.managedByHelm: true`; enables `helm upgrade` to update CRDs\n- **`tests/`** ‚Äî `helm-unittest` YAML test files validating default rendering + all toggle combinations\n- **CI job** ‚Äî New `helm-lint` job in `ci.yml`: `helm lint`, `ct lint --all`, `helm-unittest`\n- **Release workflow** ‚Äî New `.github/workflows/helm-release.yml`: on `chart/v*` tag, runs `helm package` + `helm push` to `oci://ghcr.io/<org>/charts/memcached-operator`"
}