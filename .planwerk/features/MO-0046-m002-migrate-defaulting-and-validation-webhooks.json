{
  "feature_id": "MO-0046",
  "title": "M002: Migrate defaulting and validation webhooks to v1beta1",
  "slug": "m002-migrate-defaulting-and-validation-webhooks",
  "status": "proposed",
  "phase": null,
  "summary": "",
  "description": "**Size:** üì¶ medium\n**Category:** backend\n**Priority:** critical\n**Source:** Proposed for 'API Promotion v1alpha1 ‚Üí v1beta1\n\nNew package ap'\n\nMove webhook logic from v1alpha1 to v1beta1 and delete the v1alpha1 webhook files:\n\n1. **api/v1beta1/memcached_webhook.go** ‚Äî Migrate `MemcachedCustomDefaulter` from v1alpha1. Update the webhook path to `/mutate-memcached-c5c3-io-v1beta1-memcached`. Preserve all defaulting constants and logic (default replicas, image, port, memory limit, etc.).\n2. **api/v1beta1/memcached_validation_webhook.go** ‚Äî Migrate `MemcachedCustomValidator` from v1alpha1. Update the webhook path to `/validate-memcached-c5c3-io-v1beta1-memcached`. Preserve all validation rules.\n3. **Delete** `api/v1alpha1/memcached_webhook.go` ‚Äî v1alpha1 requests will be converted to v1beta1 by the API server before admission runs.\n4. **Delete** `api/v1alpha1/memcached_validation_webhook.go` ‚Äî same reason.\n5. **Delete** `api/v1alpha1/memcached_webhook_test.go` and `api/v1alpha1/memcached_validation_webhook_test.go` ‚Äî tests for deleted code.\n\nWrite new webhook tests in api/v1beta1/ covering both defaulting and validation scenarios (ported from deleted v1alpha1 tests).\n\n**Rationale:** With conversion in place, the API server converts v1alpha1 requests to v1beta1 before admission. Only v1beta1 webhooks are needed, eliminating duplicate webhook logic and ensuring a single source of truth for defaults and validation.\n\n**Affected Areas:**\n- api/v1beta1/memcached_webhook.go\n- api/v1beta1/memcached_validation_webhook.go\n- api/v1alpha1/memcached_webhook.go\n- api/v1alpha1/memcached_validation_webhook.go\n- api/v1alpha1/memcached_webhook_test.go\n- api/v1alpha1/memcached_validation_webhook_test.go",
  "stories": [],
  "requirements": [],
  "tasks": [],
  "test_specifications": [],
  "affected_files": [],
  "similar_patterns": [],
  "review_criteria": [],
  "implementation_notes": "",
  "status_history": {
    "proposed": {
      "github_account": "berendt",
      "timestamp": "2026-02-21T16:26:33.927289"
    }
  },
  "elaboration": "**Size:** üèóÔ∏è large\n**Category:** backend\n**Priority:** high\n\n## Summary\n\nPromote the Memcached CRD API from `v1alpha1` to `v1beta1`. The new `v1beta1` becomes the **storage version** (hub) while `v1alpha1` is retained as a **served but non-storage spoke** for backward compatibility. A conversion webhook enables automatic translation between versions. The controller, defaulting webhooks, and validation webhooks all move to `v1beta1` types; the v1alpha1 webhooks are removed entirely ‚Äî the API server converts v1alpha1 requests to the storage version before admission runs.\n\n## Scope\n\n**Included:**\n- New `api/v1beta1/` package with Memcached types (identical schema to v1alpha1, promoted)\n- `api/v1beta1/groupversion_info.go` ‚Äî `memcached.c5c3.io/v1beta1` registration\n- `api/v1beta1/memcached_conversion.go` ‚Äî `conversion.Hub` implementation (empty `Hub()` method)\n- `api/v1alpha1/memcached_conversion.go` ‚Äî `conversion.Convertible` implementation (`ConvertTo`/`ConvertFrom`)\n- Defaulting webhook (`MemcachedCustomDefaulter`) for v1beta1 ‚Äî migrated from v1alpha1\n- Validation webhook (`MemcachedCustomValidator`) for v1beta1 ‚Äî migrated from v1alpha1\n- **Remove** `api/v1alpha1/memcached_webhook.go` and `api/v1alpha1/memcached_validation_webhook.go` (rely on conversion + v1beta1 webhooks)\n- CRD manifest: `v1beta1` with `storage: true`, `v1alpha1` with `storage: false, served: true`, conversion webhook strategy\n- Conversion webhook configuration in `config/webhook/`\n- Controller switched from `memcachedv1alpha1.Memcached` to `memcachedv1beta1.Memcached`\n- `cmd/main.go` ‚Äî register v1beta1 scheme, setup v1beta1 webhooks\n- `suite_test.go` ‚Äî register v1beta1 scheme + webhooks\n- Builder functions (`constructDeployment`, `constructService`, `constructPDB`, `constructNetworkPolicy`, `constructServiceMonitor`) accept v1beta1 types\n- All ~30 controller test files migrated to v1beta1 types\n- v1beta1 sample YAML files in `config/samples/`\n- Migration documentation with deprecation notice for v1alpha1\n\n**Excluded (YAGNI):**\n- New fields or schema changes in v1beta1 (autoscaling, etc.) ‚Äî separate feature\n- Automated data migration tooling ‚Äî API server handles conversion transparently\n- v1alpha1 removal ‚Äî premature, users need deprecation window\n- Helm chart or OLM bundle updates ‚Äî separate concern\n- v1alpha1 webhook test migration ‚Äî those test files are deleted along with the webhooks\n\n## Visualization\n\n```mermaid\nflowchart TD\n    subgraph APIServer[\"API Server\"]\n        V1A[\"v1alpha1 endpoint<br/>served: true, storage: false\"]\n        V1B[\"v1beta1 endpoint<br/>served: true, storage: true\"]\n        CW[\"Conversion Webhook\"]\n        MW_B[\"Mutating Webhook<br/>v1beta1 defaulting\"]\n        VW_B[\"Validating Webhook<br/>v1beta1 validation\"]\n    end\n\n    subgraph Operator[\"Operator Process\"]\n        CTRL[\"Controller<br/>reconciles v1beta1\"]\n        REC[\"Reconciler\"]\n    end\n\n    subgraph Storage[\"etcd\"]\n        ETCD[(\"Stored as v1beta1\")]\n    end\n\n    V1A -->|\"convert to hub\"| CW\n    CW -->|\"v1beta1\"| MW_B\n    V1B --> MW_B\n    MW_B --> VW_B\n    VW_B --> ETCD\n\n    ETCD -->|\"watch v1beta1\"| CTRL\n    CTRL --> REC\n```\n\n```mermaid\nflowchart LR\n    subgraph hub[\"api/v1beta1 ‚Äî Hub\"]\n        HUB_T[\"Memcached types<br/>+kubebuilder:storageversion\"]\n        HUB_GV[\"groupversion_info.go\"]\n        HUB_DEF[\"Defaulting webhook\"]\n        HUB_VAL[\"Validation webhook\"]\n        HUB_DC[\"zz_generated.deepcopy.go\"]\n        HUB_CONV[\"Hub interface impl\"]\n    end\n\n    subgraph spoke[\"api/v1alpha1 ‚Äî Spoke\"]\n        SP_T[\"Memcached types ‚Äî no storageversion\"]\n        SP_CONV[\"Convertible interface<br/>ConvertTo / ConvertFrom\"]\n    end\n\n    subgraph ctrl[\"internal/controller\"]\n        C_MAIN[\"memcached_controller.go\"]\n        C_DEPLOY[\"deployment.go\"]\n        C_SVC[\"service.go\"]\n        C_STATUS[\"status.go\"]\n        C_PDB[\"pdb.go\"]\n        C_NP[\"networkpolicy.go\"]\n        C_SM[\"servicemonitor.go\"]\n    end\n\n    spoke -->|\"converts to/from\"| hub\n    ctrl -->|\"imports\"| hub\n```\n\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as API Server\n    participant CW as Conversion Webhook\n    participant MW as Mutating Webhook\n    participant VW as Validating Webhook\n    participant etcd\n\n    Note over Client: v1alpha1 user\n    Client->>API: POST v1alpha1/memcacheds\n    API->>CW: Convert v1alpha1 to v1beta1\n    CW-->>API: v1beta1 object\n    API->>MW: Default v1beta1\n    MW-->>API: Defaulted object\n    API->>VW: Validate v1beta1\n    VW-->>API: OK\n    API->>etcd: Store as v1beta1\n\n    Note over Client: v1beta1 user\n    Client->>API: POST v1beta1/memcacheds\n    API->>MW: Default v1beta1\n    MW-->>API: Defaulted object\n    API->>VW: Validate v1beta1\n    VW-->>API: OK\n    API->>etcd: Store as v1beta1\n```\n\n## Key Components\n\n**New files:**\n- **`api/v1beta1/memcached_types.go`** ‚Äî Promoted types with `+kubebuilder:storageversion` marker. Identical schema to v1alpha1: `MemcachedSpec`, `MemcachedStatus`, `MemcachedConfig`, `HighAvailabilitySpec`, `MonitoringSpec`, `SecuritySpec`, etc.\n- **`api/v1beta1/groupversion_info.go`** ‚Äî `GroupVersion{Group: \"memcached.c5c3.io\", Version: \"v1beta1\"}`\n- **`api/v1beta1/memcached_conversion.go`** ‚Äî `func (m *Memcached) Hub() {}` implementing `conversion.Hub`\n- **`api/v1alpha1/memcached_conversion.go`** ‚Äî `ConvertTo()`/`ConvertFrom()` implementing `conversion.Convertible` (field-by-field copy since schema is identical)\n- **`api/v1beta1/memcached_webhook.go`** ‚Äî Defaulting webhook at path `/mutate-memcached-c5c3-io-v1beta1-memcached` (migrated from v1alpha1, same constants/logic)\n- **`api/v1beta1/memcached_validation_webhook.go`** ‚Äî Validation webhook at path `/validate-memcached-c5c3-io-v1beta1-memcached` (migrated from v1alpha1)\n- **`config/samples/memcached_v1beta1_*.yaml`** ‚Äî v1beta1 sample manifests (6 files: minimal, ha, monitoring, tls, production, full)\n\n**Deleted files:**\n- **`api/v1alpha1/memcached_webhook.go`** ‚Äî v1alpha1 defaulting webhook removed\n- **`api/v1alpha1/memcached_validation_webhook.go`** ‚Äî v1alpha1 validation webhook removed\n- **`api/v1alpha1/memcached_webhook_test.go`** ‚Äî corresponding tests removed\n- **`api/v1alpha1/memcached_validation_webhook_test.go`** ‚Äî corresponding tests removed\n\n**Modified files:**\n- **`api/v1alpha1/memcached_types.go`** ‚Äî Add deprecation comment pointing to v1beta1 (no `+kubebuilder:storageversion` exists to remove)\n- **`cmd/main.go`** ‚Äî Add `memcachedv1beta1` import, register v1beta1 scheme, setup v1beta1 webhooks\n- **`internal/controller/memcached_controller.go`** ‚Äî Switch import `memcachedv1alpha1` ‚Üí `memcachedv1beta1`, update all type references\n- **`internal/controller/deployment.go`**, **`service.go`**, **`status.go`**, **`pdb.go`**, **`networkpolicy.go`**, **`servicemonitor.go`** ‚Äî Accept `v1beta1.Memcached` instead of `v1alpha1.Memcached`\n- **`internal/controller/reconcile_resource.go`** ‚Äî Update owner reference type if applicable\n- **`internal/controller/suite_test.go`** ‚Äî Register v1beta1 scheme + webhooks in envtest\n- **~30 test files in `internal/controller/`** ‚Äî Switch from `v1alpha1.Memcached` to `v1beta1.Memcached`\n\n**Regenerated files (via `make manifests`):**\n- **`config/crd/bases/memcached.c5c3.io_memcacheds.yaml`** ‚Äî Multi-version CRD with conversion webhook strategy\n- **`config/webhook/manifests.yaml`** ‚Äî Updated webhook paths for v1beta1\n- **`api/v1beta1/zz_generated.deepcopy.go`** ‚Äî Generated deepcopy"
}