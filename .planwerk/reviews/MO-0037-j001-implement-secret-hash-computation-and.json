{
  "feature_id": "MO-0037",
  "title": "J001: Implement secret hash computation and references",
  "date": "2026-02-21",
  "verdict": "NEEDS_CHANGES",
  "summary": "Implementation of computeSecretHash, fetchReferencedSecrets, and mapSecretToMemcached is correct, well-structured, and follows existing project patterns. All 16 existing tests pass, go vet is clean. However, 4 test cases explicitly required by the plan (tasks 1.2, 1.4) are missing: empty .data map for hash, TLS missing for fetch, nil Security spec for fetch, and dedup-missing for fetch. These must be added before approval.",
  "tests_checklist": [
    {"item": "All existing tests pass (16/16)", "checked": true},
    {"item": "computeSecretHash determinism tested", "checked": true},
    {"item": "computeSecretHash order-independence tested (Secret order + key order)", "checked": true},
    {"item": "computeSecretHash data change detection tested", "checked": true},
    {"item": "computeSecretHash empty input (no args) tested", "checked": true},
    {"item": "computeSecretHash nil .data tested", "checked": true},
    {"item": "computeSecretHash empty .data map tested (REQ-003 scenario 3)", "checked": false},
    {"item": "computeSecretHash hex format validated", "checked": true},
    {"item": "fetchReferencedSecrets both exist tested", "checked": true},
    {"item": "fetchReferencedSecrets SASL missing tested", "checked": true},
    {"item": "fetchReferencedSecrets TLS missing tested (task 1.4 item 3)", "checked": false},
    {"item": "fetchReferencedSecrets neither enabled tested", "checked": true},
    {"item": "fetchReferencedSecrets dedup (found) tested", "checked": true},
    {"item": "fetchReferencedSecrets dedup (missing) tested (task 1.4 item 6, REQ-005 scenario 2)", "checked": false},
    {"item": "fetchReferencedSecrets nil Security spec tested (task 1.4 item 7)", "checked": false},
    {"item": "mapSecretToMemcached SASL ref tested", "checked": true},
    {"item": "mapSecretToMemcached TLS ref tested", "checked": true},
    {"item": "mapSecretToMemcached unreferenced tested", "checked": true},
    {"item": "mapSecretToMemcached namespace scoping tested", "checked": true},
    {"item": "mapSecretToMemcached nil Security spec tested", "checked": true},
    {"item": "mapSecretToMemcached multiple CRs tested", "checked": true}
  ],
  "code_quality_checklist": [
    {"item": "Functions have single responsibility", "checked": true},
    {"item": "Functions are concise (computeSecretHash: 42 lines, fetchReferencedSecrets: 34 lines, mapSecretToMemcached: 37 lines)", "checked": true},
    {"item": "No code duplication", "checked": true},
    {"item": "Clear naming (intention-revealing)", "checked": true},
    {"item": "No magic numbers or strings", "checked": true},
    {"item": "No dead code", "checked": true},
    {"item": "Package-level doc comment present", "checked": true},
    {"item": "Function-level doc comments present", "checked": true},
    {"item": "Follows existing test patterns (package controller, testScheme, fake client)", "checked": true}
  ],
  "security_checklist": [
    {"item": "No hardcoded secrets", "checked": true},
    {"item": "SHA-256 used for hashing (cryptographically secure)", "checked": true},
    {"item": "Null-byte separators prevent hash collision between key/value boundaries", "checked": true},
    {"item": "Namespace-scoped listing in mapSecretToMemcached prevents cross-tenant leakage", "checked": true},
    {"item": "No sensitive data exposed in logs or errors", "checked": true}
  ],
  "architecture_checklist": [
    {"item": "Pure helper functions with no side effects on reconciler state", "checked": true},
    {"item": "Correct use of handler.MapFunc closure pattern (ctx in closure, not outer function)", "checked": true},
    {"item": "Nil-safe traversal of nested spec fields", "checked": true},
    {"item": "Deduplication of Secret names via map[string]struct{}", "checked": true},
    {"item": "File location matches project structure (internal/controller/)", "checked": true}
  ],
  "dry_yagni_checklist": [
    {"item": "No duplicated code", "checked": true},
    {"item": "No unused functions or exports", "checked": true},
    {"item": "No future-proofing or speculative features", "checked": true}
  ],
  "fail_fast_checklist": [
    {"item": "Early return for empty/nil input in computeSecretHash", "checked": true},
    {"item": "Early return for no refs in fetchReferencedSecrets", "checked": true},
    {"item": "Early return on List error in mapSecretToMemcached", "checked": true}
  ],
  "defensive_checklist": [
    {"item": "Nil Security spec handled in fetchReferencedSecrets", "checked": true},
    {"item": "Nil SASL/TLS specs handled in fetchReferencedSecrets", "checked": true},
    {"item": "Nil Security spec handled in mapSecretToMemcached", "checked": true},
    {"item": "Nil SASL/TLS specs handled in mapSecretToMemcached", "checked": true},
    {"item": "Empty Secret name skipped in fetchReferencedSecrets", "checked": true}
  ],
  "security_findings": [],
  "architecture_findings": [
    {
      "severity": "INFO",
      "description": "mapSecretToMemcached does not check the Enabled flag on SASL/TLS specs when matching, while fetchReferencedSecrets does. This is an intentional design choice — the watch handler is more permissive, which is safer for edge cases where a feature is being toggled. The reconciler (fetchReferencedSecrets) filters correctly. No action needed.",
      "location": "internal/controller/secret.go:125-129",
      "fix": "N/A — intentional design"
    }
  ],
  "issues_found": [
    {
      "id": "TE2-1",
      "severity": "major",
      "check_id": "TE2",
      "description": "Missing planned test: computeSecretHash with empty .data map (map[string][]byte{}). Task 1.2 item (6) and REQ-003 scenario 3 explicitly require this. The nil .data case is tested but the empty map case exercises a different Go code path (len(map{}) == 0 vs len(nil) == 0).",
      "location": "internal/controller/secret_test.go",
      "fix": "Add TestComputeSecretHash_EmptyDataMap with Secret{Data: map[string][]byte{}} and assert empty string return."
    },
    {
      "id": "TE2-2",
      "severity": "major",
      "check_id": "TE2",
      "description": "Missing planned test: fetchReferencedSecrets with TLS Secret missing. Task 1.4 item (3) explicitly requires this. Only SASL missing is tested (TestFetchReferencedSecrets_SASLMissing). The TLS missing path is symmetrical but exercises TLS-specific nil checks.",
      "location": "internal/controller/secret_test.go",
      "fix": "Add TestFetchReferencedSecrets_TLSMissing: enable both SASL+TLS, provide only the SASL Secret, assert TLS name in missing list."
    },
    {
      "id": "TE2-3",
      "severity": "major",
      "check_id": "TE2",
      "description": "Missing planned test: fetchReferencedSecrets with nil Security spec. Task 1.4 item (7) explicitly requires this. TestFetchReferencedSecrets_NeitherEnabled tests disabled (non-nil) specs, not nil Security. This exercises the mc.Spec.Security != nil guard at secret.go:71.",
      "location": "internal/controller/secret_test.go",
      "fix": "Add TestFetchReferencedSecrets_NilSecuritySpec: Memcached CR with Spec.Security = nil, assert found=nil, missing=nil."
    },
    {
      "id": "TE2-4",
      "severity": "major",
      "check_id": "TE2",
      "description": "Missing planned test: fetchReferencedSecrets dedup when same Secret name is missing. Task 1.4 item (6) and REQ-005 scenario 2 explicitly require this. TestFetchReferencedSecrets_Dedup only tests the found (existing) case.",
      "location": "internal/controller/secret_test.go",
      "fix": "Add TestFetchReferencedSecrets_DedupMissing: SASL+TLS both reference 'shared-secret' which does not exist, assert missing=['shared-secret'] (length 1)."
    },
    {
      "id": "V3-1",
      "severity": "minor",
      "check_id": "V3",
      "description": "golangci-lint cannot run due to toolchain version mismatch (golangci-lint built with Go 1.24, project targets Go 1.25.0). This is a pre-existing infrastructure issue, not caused by this PR.",
      "location": "N/A (infrastructure)",
      "fix": "Upgrade golangci-lint to a build compiled with Go 1.25+. Not blocking for this review."
    }
  ],
  "suggested_improvements": [
    "Consider adding a TestComputeSecretHash_100Runs stress test that calls computeSecretHash 100 times and asserts all results are identical, as mentioned in the review criteria (optional — current determinism test covers the core property)",
    "Doc filename is secret-hash-and-references.md vs plan's secret-hash-computation.md — the actual name is more descriptive, no change needed, but note for plan tracking"
  ],
  "next_steps": [
    "Add 4 missing test cases: TestComputeSecretHash_EmptyDataMap, TestFetchReferencedSecrets_TLSMissing, TestFetchReferencedSecrets_NilSecuritySpec, TestFetchReferencedSecrets_DedupMissing",
    "Re-run go test to confirm all tests pass",
    "Re-submit for review"
  ]
}
