{
  "feature_id": "MO-0033",
  "title": "I002: Add network and service E2E tests",
  "date": "2026-02-21",
  "verdict": "NEEDS_CHANGES",
  "summary": "Two Chainsaw E2E tests added: network-policy (11 steps covering full lifecycle — creation, allowedSources, TLS+monitoring port adaptation, deletion) and service-annotations (6 steps covering annotation propagation, update, and removal). 20 new YAML files across test/e2e/network-policy/ and test/e2e/service-annotations/. Documentation updated in chainsaw-e2e-tests.md with test descriptions, file structure, requirement coverage matrix, and known limitations. Network-policy test is solid and follows all conventions. Service-annotations test has one accuracy issue (missing REQ-E2E-SA-002 reference) and one scope concern (extra update step not in plan).",
  "review_steps": {
    "1_intent": "Plan specifies 2 E2E tests: network-policy (10 steps, REQ-E2E-NP-001 through NP-004) and service-annotations (4 steps, REQ-E2E-SA-001 and SA-002). Plus documentation update (REQ-E2E-DOC-001).",
    "2_scope": "Changes limited to test/e2e/network-policy/ (13 new files), test/e2e/service-annotations/ (7 new files), docs/reference/backend/chainsaw-e2e-tests.md. No operator code modified. Network-policy adds 1 extra step (assert-deployment-ready) — reasonable stability guard. Service-annotations adds 2 extra steps (update-annotations, assert-service-annotations-updated) — scope creep beyond plan.",
    "3_verification": "All YAML files are syntactically valid. Consistent 2-space indentation. Proper --- document separators. No Go code to typecheck/lint — tests are declarative YAML only.",
    "4_patterns": "Timeouts (apply:30s, assert:120s, delete:30s, error:30s) match all existing tests. Directory layout follows test/e2e/{name}/chainsaw-test.yaml. Numbered files follow existing pattern. CR naming (test-netpol, test-svc-ann) follows established convention (test-monitoring, test-sasl, test-tls, test-basic, etc.). Labels use standard app.kubernetes.io/* keys. Cert-manager setup matches tls-encryption pattern exactly. Error assertion matches monitoring-toggle pattern exactly.",
    "5_tests": "Network-policy test covers: NP creation with podSelector + port 11211, allowedSources with podSelector peer, TLS+monitoring port adaptation (11211/11212/9150), NP disable/deletion. Service-annotations test covers: annotation propagation, annotation value update, annotation removal. Known limitation: Chainsaw partial matching cannot assert absence of annotations field — documented in Known Limitations.",
    "6_security": "No secrets or credentials. Self-signed certs for TLS step only. No runtime testing.",
    "7_complexity": "Linear step sequences, minimal YAML. Each file serves a single purpose. No over-engineering.",
    "8_completeness": "Network-policy: all 4 requirements (NP-001 through NP-004, plus NP-005) covered. Service-annotations: both requirements (SA-001, SA-002) covered. Documentation: complete with file structure, step tables, CRD fields, prerequisite notes, known limitations. One metadata accuracy issue: service-annotations description missing REQ-E2E-SA-002."
  },
  "tests_checklist": [
    {"item": "Network-policy test directory exists with chainsaw-test.yaml and 12 resource files", "checked": true},
    {"item": "Service-annotations test directory exists with chainsaw-test.yaml and 6 resource files", "checked": true},
    {"item": "NP asserts: NetworkPolicy with podSelector matching operator labels, policyTypes [Ingress], port 11211/TCP", "checked": true},
    {"item": "NP asserts: allowedSources propagated as ingress from podSelector peer", "checked": true},
    {"item": "NP asserts: all three ports (11211, 11212, 9150) with TCP protocol when TLS+monitoring enabled", "checked": true},
    {"item": "NP asserts: NetworkPolicy deleted via error assertion when networkPolicy disabled", "checked": true},
    {"item": "SA asserts: Service metadata.annotations contains both custom annotations", "checked": true},
    {"item": "SA asserts: Service structure correct (headless, port 11211, correct selector/labels)", "checked": true},
    {"item": "Cert-manager setup follows tls-encryption pattern (self-signed Issuer + Certificate)", "checked": true},
    {"item": "Error assertion follows monitoring-toggle pattern (minimal resource reference)", "checked": true},
    {"item": "All chainsaw-test.yaml files use standard timeouts", "checked": true},
    {"item": "All YAML files are syntactically valid", "checked": true}
  ],
  "code_quality_checklist": [
    {"item": "Follows existing Chainsaw test directory layout", "checked": true},
    {"item": "CR naming follows test-{short} convention (test-netpol, test-svc-ann)", "checked": true},
    {"item": "Patch files use minimal format (apiVersion, kind, metadata.name, changed spec only)", "checked": true},
    {"item": "No code duplication — each assertion file targets a specific state", "checked": true},
    {"item": "File numbering convention consistent (00-, 01-, 02-, etc.)", "checked": true},
    {"item": "Labels use standard app.kubernetes.io/* keys throughout", "checked": true}
  ],
  "security_checklist": [
    {"item": "No hardcoded secrets or credentials in test files", "checked": true},
    {"item": "Self-signed certificates used for test TLS only", "checked": true},
    {"item": "No sensitive data exposed in assertions", "checked": true}
  ],
  "architecture_checklist": [
    {"item": "Test structure matches existing E2E test patterns", "checked": true},
    {"item": "Step ordering is logical (create → assert → patch → assert → cleanup)", "checked": true},
    {"item": "Cert-manager resources properly scoped to test namespace", "checked": true},
    {"item": "Documentation integrated into existing chainsaw-e2e-tests.md", "checked": true}
  ],
  "dry_yagni_checklist": [
    {"item": "No duplicated assertion content across files", "checked": true},
    {"item": "Each YAML file serves exactly one purpose", "checked": true},
    {"item": "No unused or dead test files", "checked": true}
  ],
  "fail_fast_checklist": [
    {"item": "Network-policy test asserts deployment ready before checking NP", "checked": true},
    {"item": "Cert-manager asserts certificate ready before TLS patch", "checked": true}
  ],
  "defensive_checklist": [
    {"item": "Error assertion used for deletion verification (not assert)", "checked": true},
    {"item": "Known limitation documented for annotation absence assertion", "checked": true}
  ],
  "security_findings": [],
  "architecture_findings": [],
  "issues_found": [
    {
      "id": "SA-DESC-001",
      "check_ref": "C1, DA1",
      "severity": "major",
      "file": "test/e2e/service-annotations/chainsaw-test.yaml:11",
      "description": "Test description references only REQ-E2E-SA-001 but the test covers both SA-001 (annotation propagation) and SA-002 (annotation removal). The network-policy test correctly lists all five requirements in its description. This is an accuracy inconsistency in test metadata.",
      "fix": "Change line 11 from '(REQ-E2E-SA-001).' to '(REQ-E2E-SA-001, REQ-E2E-SA-002).'"
    },
    {
      "id": "SA-SCOPE-001",
      "check_ref": "C1",
      "severity": "minor",
      "file": "test/e2e/service-annotations/chainsaw-test.yaml:26-33",
      "description": "Steps 'update-annotations' and 'assert-service-annotations-updated' (files 02-patch-update-annotations.yaml, 03-assert-service-updated.yaml) are not in the plan. Plan specifies 4 steps: create, assert, remove, assert-cleared. The extra update step adds useful coverage but is scope creep. Accepting as-is since it adds value and doesn't break anything.",
      "fix": "No action required — noting for completeness. The extra coverage is beneficial."
    },
    {
      "id": "SA-ASSERT-001",
      "check_ref": "TE7",
      "severity": "minor",
      "file": "test/e2e/service-annotations/05-assert-service-no-annotations.yaml",
      "description": "Annotation removal assertion cannot verify annotations are actually absent due to Chainsaw partial matching limitation. The assertion YAML omits metadata.annotations, which passes regardless of whether annotations exist on the resource. This is a known Chainsaw limitation, properly documented in the Known Limitations section of chainsaw-e2e-tests.md.",
      "fix": "No action required — Chainsaw limitation. Could add JMESPath binding for stronger assertion in a follow-up, but current approach is acceptable and documented."
    }
  ],
  "suggested_improvements": [
    "Consider using Chainsaw JMESPath bindings in 05-assert-service-no-annotations.yaml to positively assert annotation absence (would upgrade test confidence)",
    "The network-policy test's assert-deployment-ready step (01-assert-deployment.yaml) is a good stability pattern — consider adding it to other tests that don't have it"
  ],
  "next_steps": [
    "Fix: Add REQ-E2E-SA-002 to service-annotations chainsaw-test.yaml description (line 11)"
  ]
}
